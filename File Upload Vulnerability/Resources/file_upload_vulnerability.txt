We notice there is a page for uploading images at http://$IP/?page=upload#

We try to upload a couple of files and it seems to accept some image types and reject others.

We successfully upload a .jpeg file and it displays a message saying the file was uploaded successfully at /tmp/image_name.jpeg

In Firefox, we go to the Developer Tools and check the Network tab.

We see that the request to upload the file is a POST request to /upload.php with the following parameters body:

------------------------------------------------------------------------------------------------------------------------

------geckoformboundaryeb8db929f0c165d8796d12cb846ec726
Content-Disposition: form-data; name="MAX_FILE_SIZE"

100000
------geckoformboundaryeb8db929f0c165d8796d12cb846ec726
Content-Disposition: form-data; name="uploaded"; filename="image_name.jpeg"
Content-Type: image/jpeg

------------------------------------------------------------------------------------------------------------------------

We change the filename to image_name.php and try to upload it again.

After this we get the flag in the response.

The file upload form is vulnerable to a file upload attack because it does not properly sanitize and validate the filename and file type of the uploaded file and the server just trusts the Content-Type received header.

This allows an attacker to upload any type of files at any location on the server where the server process has access, which could crash the server or lead to remote code execution.

If we now try to create a hacky script "hack.sh" and updload with it with curl, emulating the form submission, we also successfully get the flag:

`curl -s -X POST -F "uploaded=@./hacked.sh;type=image/jpeg" -F "Upload=Upload" http://192.168.1.90/index.php\?page\=upload`

------------------------------------------------------------------------------------------------------------------------

Preventing File Upload Vulnerabilities

1. Extension Validation
- Use both whitelist and blacklist extension validation.
- Whitelist: Only allow specific file types to be uploaded.
- Blacklist: Block specific file types from being uploaded.

2. Content Validation
- Never trust a file uploaded by a client and always perform validations in server. For example:
    - Always make sure that the file extension matches the file's content.
    - Check the file's content type and ensure it matches the expected type.

3. Upload Disclosure
- Avoid disclosing the uploads directory or providing direct access to the uploaded file.
- Avoid disclosing the file name of uploaded files.
